version: '3.8'

services:
  # NATS 消息队列
  nats:
    image: nats:2.10-alpine
    container_name: alpha-trade-nats
    command: "-js -sd /data" # 开启 JetStream 持久化，数据存放在 /data
    ports:
      - "4222:4222" # 客户端端口
      - "8222:8222" # 监控端口
    volumes:
      - nats_data:/data
    restart: always

  # AI 决策 Agent
  ai-agent:
    build:
      context: ./ai-agent
      dockerfile: Dockerfile
    container_name: alpha-trade-ai-agent
    depends_on:
      - nats
    environment:
      - NATS_URL=nats://nats:4222
      - GOOGLE_API_KEY=${GOOGLE_API_KEY} # 从宿主机 .env 文件读取
    restart: always

  # RSSHub - 社交媒体转换引擎
  rsshub:
    image: diygod/rsshub:latest
    container_name: alpha-trade-rsshub
    restart: always
    ports:
      - "1200:1200"
    environment:
      - NODE_ENV=production
      - CACHE_TYPE=redis
      - REDIS_URL=redis://redis:6379/0
      - TWITTER_USERNAME=${TWITTER_USERNAME} # 选填：用于增加抓取成功率
      - TWITTER_PASSWORD=${TWITTER_PASSWORD} # 选填
    depends_on:
      - redis

  # Redis - RSSHub 缓存
  redis:
    image: redis:alpine
    container_name: alpha-trade-redis
    restart: always

  # PostgreSQL - 行情/事件数据存储
  postgres:
    image: postgres:16-alpine
    container_name: alpha-trade-postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-alpha}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-alpha_pwd}
      - POSTGRES_DB=${POSTGRES_DB:-alpha_trade}
      - TZ=UTC
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./sql/pg:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-alpha} -d ${POSTGRES_DB:-alpha_trade}" ]
      interval: 5s
      timeout: 3s
      retries: 20

  # KLine Loader - 一次性导入日K到 PostgreSQL（可按环境变量控制时间范围）
  kline-loader:
    build:
      context: ./ai-agent
      dockerfile: Dockerfile
    container_name: alpha-trade-kline-loader
    depends_on:
      - postgres
    environment:
      - PG_DSN=postgresql://${POSTGRES_USER:-alpha}:${POSTGRES_PASSWORD:-alpha_pwd}@postgres:5432/${POSTGRES_DB:-alpha_trade}?sslmode=disable
      - KLINE_EXCHANGE=${KLINE_EXCHANGE:-okx}
      - KLINE_SYMBOL=${KLINE_SYMBOL:-BTC-USDT}
      # 支持: 15m / 1H / 4H / 1D（OKX bar）
      - KLINE_INTERVAL=${KLINE_INTERVAL:-1D}
      - KLINE_START_DATE=${KLINE_START_DATE:-2025-01-01}
      - KLINE_END_DATE=${KLINE_END_DATE:-2025-12-31}
    command: [ "python", "tools/import_klines_to_pg.py" ]
    restart: "no"

  # Jaeger - 分布式链路追踪
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: alpha-trade-jaeger
    ports:
      - "16686:16686" # UI 端口
      - "4317:4317"   # OTLP gRPC 接收端口
      - "4318:4318"   # OTLP HTTP 接收端口
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    restart: always

  # OpenTelemetry Collector - 实现尾部采样 (Tail-sampling)
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: alpha-trade-otel-collector
    command: ["--config=/etc/otel-collector.yaml"]
    volumes:
      - ./etc/otel-collector.yaml:/etc/otel-collector.yaml
    depends_on:
      - jaeger
    restart: always

  # Prometheus - 指标监控
  prometheus:
    image: prom/prometheus:latest
    container_name: alpha-trade-prometheus
    volumes:
      - ./etc/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    restart: always

volumes:
  nats_data:
  pg_data:


