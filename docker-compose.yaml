version: '3.8'

services:
  # NATS 消息队列
  nats:
    image: nats:2.10-alpine
    container_name: alpha-trade-nats
    command: "-js -sd /data" # 开启 JetStream 持久化，数据存放在 /data
    ports:
      - "4222:4222" # 客户端端口
      - "8222:8222" # 监控端口
    volumes:
      - nats_data:/data
    restart: always

  # RSSHub - 社交媒体转换引擎
  rsshub:
    image: diygod/rsshub:latest
    container_name: alpha-trade-rsshub
    restart: always
    ports:
      - "1200:1200"
    environment:
      - NODE_ENV=production
      - CACHE_TYPE=redis
      - REDIS_URL=redis://redis:6379/0
      - TWITTER_USERNAME=${TWITTER_USERNAME} # 选填：用于增加抓取成功率
      - TWITTER_PASSWORD=${TWITTER_PASSWORD} # 选填
    depends_on:
      - redis

  # Redis - RSSHub 缓存 + 应用缓存
  redis:
    image: redis:alpine
    container_name: alpha-trade-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # PostgreSQL - 行情/事件数据存储
  postgres:
    image: postgres:16-alpine
    container_name: alpha-trade-postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - TZ=UTC
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./sql/pg:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}" ]
      interval: 5s
      timeout: 3s
      retries: 20


  # Jaeger - 分布式链路追踪
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: alpha-trade-jaeger
    ports:
      - "16686:16686" # UI 端口
      - "4317:4317"   # OTLP gRPC 接收端口
      - "4318:4318"   # OTLP HTTP 接收端口
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    restart: always

  # OpenTelemetry Collector - 实现尾部采样 (Tail-sampling)
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: alpha-trade-otel-collector
    command: ["--config=/etc/otel-collector.yaml"]
    volumes:
      - ./etc/otel-collector.yaml:/etc/otel-collector.yaml
    depends_on:
      - jaeger
    restart: always

  # Prometheus - 指标监控
  prometheus:
    image: prom/prometheus:latest
    container_name: alpha-trade-prometheus
    volumes:
      - ./etc/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    restart: always
    depends_on:
      - alpha-trade

  # Alpha-Trade 应用
  alpha-trade:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: alpha-trade-app
    ports:
      - "8888:8888"  # API 端口
      - "9091:9091"  # Prometheus metrics 端口
    environment:
      - DB_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_SUDO_SECRET=${AUTH_SUDO_SECRET}
    volumes:
      - ./logs:/app/logs
      - ./etc/alpha_trade.yaml:/app/etc/alpha_trade.yaml:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8888/api/v1/system/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  nats_data:
  pg_data:
  redis_data:


